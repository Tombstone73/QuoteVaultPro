# Attachments & Thumbnails Pipeline

**Version**: TitanOS v1.0  
**Last Updated**: January 7, 2026

---

## 1. Overview

### What is an Attachment?

An **attachment** is a file uploaded to the system and associated with a business entity (order, quote, customer, etc.). Attachments are stored on disk in a multi-tenant directory structure and tracked in the database with metadata including:

- Original filename
- Storage location (relative path)
- MIME type
- Size
- Upload timestamp
- Uploader identity

### What is a Thumbnail?

A **thumbnail** is a derivative image generated from an attachment to provide quick visual preview without loading the full file. Thumbnails are generated asynchronously by a background worker after upload.

**Supported source types**:
- PDFs ‚Üí generates 320px thumbnail from page 1
- Images (JPEG, PNG, WebP, TIFF) ‚Üí generates 320px thumb + 1600px preview

### Why Thumbnails Must Be Persisted

Thumbnails MUST be persisted to the database because:

1. **Refresh Safety**: Client-side state is ephemeral. After page refresh, thumbnails must be available from the API.
2. **Async Generation**: Thumbnails are generated by a background worker, not during upload. Without persistence, the UI would lose thumbnails after the worker completes.
3. **Multi-Instance**: In production, upload and worker may run on different server instances. File system changes must be reflected in shared database state.
4. **Failure Recovery**: Persisted status fields (`thumb_status`, `thumb_error`) enable monitoring and retry logic.

**Anti-Pattern**: Generating thumbnails and only returning URLs in-memory without updating the database will cause thumbnails to disappear after refresh.

---

## 2. Core Tables

### `public.order_attachments`

Primary table for files attached to orders.

#### Key Columns

| Column | Type | Purpose | Source of Truth? |
|--------|------|---------|------------------|
| `id` | UUID | Primary key, used in URLs | ‚úÖ Yes |
| `order_id` | UUID | Foreign key to `orders.id` (NOT display order number) | ‚úÖ Yes |
| `file_name` | VARCHAR | Display name (may be sanitized) | Derived |
| `original_filename` | VARCHAR | Exact client-provided filename | ‚úÖ Yes |
| `stored_filename` | VARCHAR | Sanitized disk filename (often NULL for legacy) | No |
| `relative_path` | TEXT | **Canonical source file pointer** (e.g., `org_titan_001/orders/{orderId}/{hash}_{filename}.pdf`) | ‚úÖ Yes |
| `file_url` | TEXT | Alias/fallback for `relative_path` | Derived |
| `thumb_key` | TEXT | **Canonical thumbnail pointer** (e.g., `thumbs/org_titan_001/order/{attachmentId}.thumb.jpg`) | ‚úÖ Yes |
| `preview_key` | TEXT | **Canonical preview pointer** (e.g., `thumbs/org_titan_001/order/{attachmentId}.preview.jpg`) | ‚úÖ Yes |
| `thumbnail_relative_path` | TEXT | Legacy field (prefer `thumb_key`) | Legacy |
| `thumbnail_url` | TEXT | **Never source of truth** - derived during enrichment | ‚ùå No |
| `thumb_status` | ENUM | `uploaded` ‚Üí `thumb_pending` ‚Üí `thumb_ready` OR `thumb_failed` | ‚úÖ Yes |
| `thumb_error` | TEXT | Error message if `thumb_status = 'thumb_failed'` | Diagnostic |
| `thumbnail_generated_at` | TIMESTAMP | When thumbnail was successfully created | Audit |
| `storage_provider` | ENUM | `local`, `supabase`, or NULL (treated as `local`) | Config |
| `mime_type` | VARCHAR | File content type | Metadata |
| `file_size` | INTEGER | Bytes | Metadata |
| `created_at` | TIMESTAMP | Upload timestamp | Audit |
| `uploaded_by_user_id` | UUID | Uploader identity | Audit |

#### Critical Distinctions

- **`order_id` is a UUID**: Never confuse this with display order numbers like `ORD-1001`. Use `orders.id`, not `orders.order_number`.
- **`relative_path` vs `file_url`**: Both may contain the same value. `relative_path` is preferred; `file_url` is a legacy alias.
- **`thumb_key` is the canonical thumbnail pointer**: Never rely on `thumbnail_url` as source of truth. `thumbnail_url` is computed during API enrichment from `thumb_key`.
- **NULL `storage_provider` means local**: Legacy attachments may have NULL. The worker treats NULL as `'local'`.

---

## 3. Storage & Routing Rules

### FILE_STORAGE_ROOT

**Environment Variable**: `FILE_STORAGE_ROOT`  
**Default**: `./uploads` (relative to project root)  
**Purpose**: Base directory for all local file storage (source files + thumbnails)

### Path Resolution

```
Relative Path: org_titan_001/orders/2fa414b0-.../file.pdf
Absolute Path: <FILE_STORAGE_ROOT>/org_titan_001/orders/2fa414b0-.../file.pdf
```

### /objects/* Route

**Endpoint**: `GET /objects/:objectPath(*)`  
**Handler**: `server/routes/attachments.routes.ts`

**Resolution Order**:
1. Try Supabase (if configured and `storageProvider = 'supabase'`)
2. Try local filesystem: `resolveLocalStoragePath(objectPath)` ‚Üí `<FILE_STORAGE_ROOT>/{objectPath}`
3. Try GCS/Replit ObjectStorage (if configured)
4. Return 404

**Key Behavior**:
- The route serves both source files AND thumbnails
- Thumbnails use paths like `/objects/thumbs/org_titan_001/order/{attachmentId}.thumb.jpg`
- Source files use paths like `/objects/org_titan_001/orders/{orderId}/{hash}_{filename}.pdf`
- Both resolve to `FILE_STORAGE_ROOT`

### Expected Directory Structure

```
uploads/
‚îú‚îÄ‚îÄ org_titan_001/
‚îÇ   ‚îú‚îÄ‚îÄ orders/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {orderId}/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {hash}_{filename}.pdf
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {hash}_{filename}.jpg
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ quotes/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ org_another_tenant/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ thumbs/
    ‚îú‚îÄ‚îÄ org_titan_001/
    ‚îÇ   ‚îú‚îÄ‚îÄ order/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {attachmentId}.thumb.jpg
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ {attachmentId}.preview.jpg
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
    ‚îÇ   ‚îî‚îÄ‚îÄ quote/
    ‚îÇ       ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ org_another_tenant/
        ‚îî‚îÄ‚îÄ ...
```

**Multi-Tenant Path Rules**:
- Organization ID MUST be first segment: `org_{id}/...`
- Thumbnails use normalized org prefix in their own subtree: `thumbs/org_{id}/...`
- Never strip or modify org prefixes (legacy bugs exist where `org_` was double-prefixed)

---

## 4. Thumbnail Worker Contract

### Worker Location
`server/workers/thumbnailWorker.ts`

### Selection Query

The worker polls for attachments needing thumbnails:

```typescript
WHERE (
  file_url IS NOT NULL
  AND file_url NOT LIKE 'http%'
  AND (storage_provider IN ('supabase', 'local') OR storage_provider IS NULL)
  AND thumb_key IS NULL
  AND thumb_status IN ('uploaded', 'thumb_pending')
)
```

**Key Points**:
- NULL `storage_provider` is treated as `'local'`
- External HTTP URLs are skipped
- Only processes rows missing `thumb_key`
- Will not re-process `thumb_ready` or `thumb_failed` unless manually reset

### storageProvider Interpretation

```typescript
const storageProvider = row.storageProvider || 'local';
```

NULL or empty ‚Üí defaults to `'local'`

### Source File Resolution

**For local storage**:
```typescript
const resolvedPath = resolveLocalStoragePath(fileKey);
// Example:
// Input:  org_titan_001/orders/2fa414b0-.../file.pdf
// Output: C:/titan-automation/QuoteVaultPro/uploads/org_titan_001/orders/2fa414b0-.../file.pdf
```

**Retry Logic**: 2 attempts with 200ms delay (handles file system flush timing)

### Thumbnail Write Paths

**PDF**:
```
thumbKey = thumbs/{orgId}/order/{attachmentId}.thumb.jpg
Absolute = <FILE_STORAGE_ROOT>/thumbs/{orgId}/order/{attachmentId}.thumb.jpg
```

**Image**:
```
thumbKey    = thumbs/{orgId}/order/{attachmentId}.thumb.jpg
previewKey  = thumbs/{orgId}/order/{attachmentId}.preview.jpg
```

### Required DB Updates (Atomic)

**Success**:
```sql
UPDATE order_attachments SET
  thumb_key = 'thumbs/org_titan_001/order/{id}.thumb.jpg',
  preview_key = 'thumbs/org_titan_001/order/{id}.preview.jpg',  -- Images only
  thumb_status = 'thumb_ready',
  thumb_error = NULL,
  thumbnail_generated_at = NOW(),
  updated_at = NOW()
WHERE id = {attachmentId};
```

**Failure**:
```sql
UPDATE order_attachments SET
  thumb_status = 'thumb_failed',
  thumb_error = 'Failed to download PDF file from storageKey=...',
  updated_at = NOW()
WHERE id = {attachmentId};
```

### Required Logging (DEBUG_THUMBNAILS=1)

```
[Thumbnail Worker] Processing order attachment {id}: { storageProvider: 'local', fileUrl: '...' }
[PdfProcessing] üìÇ Source file path: fileKey=..., resolvedPath=...
[PdfProcessing] ‚úÖ Read from local storage: size=... bytes
[ThumbnailGenerator] Writing derivative to filesystem: { thumbKey: '...', fullPath: '...' }
[PdfProcessing] ‚úÖ Thumbnail persisted to DB: attachmentId=..., thumbKey=..., thumbStatus=thumb_ready
```

---

## 5. API Contract

### Endpoint
`GET /api/orders/:orderId/attachments`

### Response Structure

```json
{
  "success": true,
  "data": [
    {
      "id": "8303790d-89c8-44fd-a611-3edc41cdc74f",
      "fileName": "WhyPSST-flyer-2024.pdf",
      "originalFilename": "WhyPSST-flyer-2024.pdf",
      "fileUrl": "org_titan_001/orders/2fa414b0-.../0ef4de72_whypsst-flyer-2024.pdf",
      "mimeType": "application/pdf",
      "fileSize": 1024000,
      "createdAt": "2026-01-07T12:00:00Z",
      
      // Persisted thumbnail fields (from DB)
      "thumbKey": "thumbs/org_titan_001/order/8303790d-.../thumb.jpg",
      "previewKey": "thumbs/org_titan_001/order/8303790d-.../preview.jpg",
      "thumbStatus": "thumb_ready",
      "thumbError": null,
      
      // Derived enrichment fields (computed during request)
      "originalUrl": "/objects/org_titan_001/orders/.../file.pdf",
      "downloadUrl": "/objects/org_titan_001/orders/.../file.pdf?download=1",
      "thumbUrl": "/objects/thumbs/org_titan_001/order/8303790d-.../thumb.jpg",
      "previewUrl": "/objects/thumbs/org_titan_001/order/8303790d-.../preview.jpg",
      "objectPath": "org_titan_001/orders/.../file.pdf",
      
      // Compatibility aliases (deprecated)
      "thumbnailUrl": "/objects/thumbs/.../thumb.jpg",
      "previewThumbnailUrl": "/objects/thumbs/.../thumb.jpg"
    }
  ]
}
```

### Persisted vs Derived

| Field | Persisted in DB? | Computed at Request Time? |
|-------|------------------|---------------------------|
| `thumbKey` | ‚úÖ Yes | No |
| `previewKey` | ‚úÖ Yes | No |
| `thumbUrl` | ‚ùå No | ‚úÖ Yes (from `thumbKey`) |
| `previewUrl` | ‚ùå No | ‚úÖ Yes (from `previewKey`) |
| `thumbnailUrl` | ‚ùå No | ‚úÖ Yes (compatibility alias) |
| `originalUrl` | ‚ùå No | ‚úÖ Yes (from `relative_path`) |
| `downloadUrl` | ‚ùå No | ‚úÖ Yes (from `relative_path` + query param) |

### Enrichment Pipeline

```typescript
// 1. Fetch from DB (includes thumbKey, previewKey)
const files = await db.select().from(orderAttachments).where(...);

// 2. Enrich with URLs
const enrichedFiles = await Promise.all(
  files.map(f => enrichAttachmentWithUrls(f, { logOnce }))
);

// enrichAttachmentWithUrls() reads thumbKey and generates:
//   thumbUrl = `/objects/${thumbKey}`
//   previewUrl = `/objects/${previewKey}`
```

### Why In-Memory Enrichment is Insufficient

**Incorrect Approach** (causes bugs):
```typescript
// ‚ùå WRONG: Generate thumbnail, return URL, but don't update DB
const thumbUrl = generateThumbnail(file);
return { ...attachment, thumbUrl };  // Lost after refresh!
```

**Correct Approach**:
```typescript
// ‚úÖ CORRECT: Generate thumbnail, persist to DB, then enrich
await db.update(orderAttachments).set({ 
  thumbKey: 'thumbs/.../thumb.jpg',
  thumbStatus: 'thumb_ready'
});
// API fetch will now include thumbKey ‚Üí enrichment generates thumbUrl
```

---

## 6. Failure Modes & Recovery

### Identifying Failed Thumbnails

```sql
-- All failed thumbnails
SELECT id, file_name, thumb_error, created_at
FROM order_attachments
WHERE thumb_status = 'thumb_failed'
ORDER BY created_at DESC;

-- Thumbnails stuck in pending state (worker may have crashed)
SELECT id, file_name, thumb_status, updated_at
FROM order_attachments
WHERE thumb_status = 'thumb_pending'
  AND updated_at < NOW() - INTERVAL '5 minutes'
ORDER BY updated_at ASC;

-- Attachments missing thumbnails but eligible for processing
SELECT id, file_name, mime_type, storage_provider
FROM order_attachments
WHERE thumb_key IS NULL
  AND thumb_status IN ('uploaded', 'thumb_pending')
  AND file_url NOT LIKE 'http%'
  AND (storage_provider IN ('local', 'supabase') OR storage_provider IS NULL);
```

### What thumb_failed Means

`thumb_status = 'thumb_failed'` indicates:
- Worker attempted to generate thumbnail
- Generation failed (see `thumb_error` for reason)
- Worker will NOT retry automatically

**Common Failure Reasons**:
- Source file not found: `"File not found after 2 attempts: fileKey=..., resolvedPath=..."`
- Unsupported file type: `"Unsupported file type for thumbnail generation: ..."`
- Dependencies unavailable: `"PDF thumbnail generation dependencies unavailable"`
- Processing error: `"Failed to download PDF file from storageKey=..."`

### Re-queuing Failed Thumbnails

```sql
-- Reset to allow worker to retry
UPDATE order_attachments
SET 
  thumb_status = 'uploaded',
  thumb_error = NULL,
  updated_at = NOW()
WHERE thumb_status = 'thumb_failed'
  AND id = '{specific-attachment-id}';

-- Bulk reset (use carefully)
UPDATE order_attachments
SET 
  thumb_status = 'uploaded',
  thumb_error = NULL,
  updated_at = NOW()
WHERE thumb_status = 'thumb_failed'
  AND thumb_error LIKE '%File not found%';
```

### UI Placeholder Behavior

**When thumbnail data is missing**, the UI correctly shows a placeholder icon:

```typescript
const thumbSrc = getThumbSrc(attachment);
// Returns: null (if thumbUrl/previewUrl/etc. all missing)

// UI renders:
{thumbSrc ? (
  <img src={thumbSrc} alt={fileName} />
) : (
  <FileIcon />  // ‚úÖ Correct placeholder
)}
```

This is **expected behavior** when:
- `thumb_status = 'uploaded'` (not yet processed)
- `thumb_status = 'thumb_pending'` (worker in progress)
- `thumb_status = 'thumb_failed'` (generation failed)
- `thumb_key = NULL` (no thumbnail exists)

---

## 7. Anti-Patterns (Explicitly Forbidden)

### ‚ùå Anti-Pattern 1: Relying on URLs Without Persisted Keys

**Problem**:
```typescript
// Generate thumbnail, return URL, but never save thumbKey to DB
const thumbUrl = `/objects/thumbs/.../thumb.jpg`;
return { ...attachment, thumbUrl };
```

**Why it fails**: After refresh, API fetches from DB. `thumbKey` is NULL, so enrichment cannot generate `thumbUrl`. Thumbnail disappears.

**Solution**: Always persist `thumbKey` to database.

### ‚ùå Anti-Pattern 2: Treating Display Order Numbers as order_id

**Problem**:
```typescript
// User sees "ORD-1001" in UI
const orderId = "ORD-1001";  // ‚ùå WRONG! This is orderNumber, not order_id
await db.select().from(orderAttachments).where(eq(orderAttachments.orderId, orderId));
```

**Why it fails**: `order_attachments.order_id` is a UUID foreign key to `orders.id`, NOT `orders.order_number`.

**Solution**:
```typescript
const order = await db.select()
  .from(orders)
  .where(eq(orders.orderNumber, "ORD-1001"))
  .limit(1);
const orderId = order[0].id;  // ‚úÖ UUID
```

### ‚ùå Anti-Pattern 3: Generating Thumbnails Without DB Updates

**Problem**:
```typescript
// Generate thumbnail file on disk, but skip DB update
await sharp(buffer).resize(320).toFile('/uploads/thumbs/.../thumb.jpg');
// No database update!
```

**Why it fails**: File exists, but database has no record. API returns NULL for `thumbKey`. UI shows placeholder.

**Solution**: Always update DB atomically with file write.

### ‚ùå Anti-Pattern 4: Assuming Remote Storage Semantics in Local Mode

**Problem**:
```typescript
// Assume Supabase is always available
const signedUrl = await supabaseService.getSignedDownloadUrl(fileKey);
```

**Why it fails**: Local development uses `FILE_STORAGE_ROOT`. Supabase may not be configured.

**Solution**: Check `storageProvider` and handle local filesystem appropriately:
```typescript
if (storageProvider === 'local') {
  const absolutePath = resolveLocalStoragePath(fileKey);
  const buffer = await fsPromises.readFile(absolutePath);
} else if (storageProvider === 'supabase') {
  const signedUrl = await supabaseService.getSignedDownloadUrl(fileKey);
  // ...
}
```

### ‚ùå Anti-Pattern 5: Using STORAGE_ROOT Instead of FILE_STORAGE_ROOT

**Problem**:
```typescript
const storageRoot = process.env.STORAGE_ROOT || './storage';  // ‚ùå WRONG
```

**Why it fails**: Thumbnails are written to `STORAGE_ROOT` but `/objects` serves from `FILE_STORAGE_ROOT`. 404s occur.

**Solution**: Always use `FILE_STORAGE_ROOT`:
```typescript
const storageRoot = process.env.FILE_STORAGE_ROOT || path.join(process.cwd(), 'uploads');
```

### ‚ùå Anti-Pattern 6: Not Handling NULL storageProvider

**Problem**:
```sql
WHERE storage_provider IN ('local', 'supabase')  -- Excludes NULL!
```

**Why it fails**: Legacy attachments have NULL `storage_provider`. Worker skips them.

**Solution**:
```sql
WHERE (storage_provider IN ('local', 'supabase') OR storage_provider IS NULL)
```

And normalize in code:
```typescript
const storageProvider = row.storageProvider || 'local';
```

---

## Debugging Checklist

When thumbnails disappear after refresh:

1. **Check Database**:
   ```sql
   SELECT id, thumb_key, preview_key, thumb_status, thumb_error
   FROM order_attachments
   WHERE id = '{attachment-id}';
   ```
   - Is `thumb_key` NULL? ‚Üí Thumbnail not persisted
   - Is `thumb_status = 'thumb_failed'`? ‚Üí Check `thumb_error`
   - Is `thumb_status = 'thumb_pending'`? ‚Üí Worker still processing or crashed

2. **Check Worker Logs** (with `DEBUG_THUMBNAILS=1`):
   - Does worker select the attachment?
   - Does source file resolve correctly?
   - Does thumbnail write succeed?
   - Does DB update succeed?

3. **Check File System**:
   ```bash
   # Does source file exist?
   ls -la ./uploads/org_titan_001/orders/{orderId}/{filename}
   
   # Does thumbnail exist?
   ls -la ./uploads/thumbs/org_titan_001/order/{attachmentId}.thumb.jpg
   ```

4. **Check API Response** (with `DEBUG_THUMBNAILS=1`):
   - Does raw DB record include `thumbKey`?
   - Does enrichment generate `thumbUrl`?
   - Does `/objects/thumbs/...` return 200?

---

## References

**Related Files**:
- `server/workers/thumbnailWorker.ts` - Thumbnail generation worker
- `server/services/pdfProcessing.ts` - PDF thumbnail generator
- `server/services/thumbnailGenerator.ts` - Image thumbnail generator
- `server/services/localStoragePath.ts` - Path resolution utility
- `server/routes/attachments.routes.ts` - `/objects/*` route handler
- `server/routes/orders.routes.ts` - `/api/orders/:id/attachments` endpoint
- `server/lib/supabaseObjectHelpers.ts` - `enrichAttachmentWithUrls()` function
- `shared/schema.ts` - Database schema definitions

**Environment Variables**:
- `FILE_STORAGE_ROOT` - Base directory for local files (default: `./uploads`)
- `DEBUG_THUMBNAILS` - Enable verbose logging (`1` or `true`)
- `ATTACHMENT_THUMBNAIL_WORKER_ENABLED` - Enable/disable worker (default: `true`)
- `THUMBNAIL_WORKER_POLL_INTERVAL_MS` - Poll frequency (default: `10000`)

---

**Document Version**: 1.0  
**Last Verified**: January 7, 2026  
**Maintainer**: TitanOS Core Team
