# Thumbnail Status Auto-Refresh Audit

**Date:** 2025-12-22  
**Purpose:** Map attachment/thumbnail status fetching and rendering to enable bounded polling for async processing (thumbnail generation, page counting).

---

## React Query Source(s)

### Hook name(s):
- `useQuery` (inline, not a custom hook)

### Query key(s):
**Line item attachments:**
- `[filesApiPath]` where `filesApiPath` is:
  - `/api/quotes/${quoteId}/line-items/${lineItemId}/files` (when quote exists)
  - `/api/line-items/${lineItemId}/files` (when quote is null, temporary line items)

**Special case query:**
- `['/api/system/status']` - checks if thumbnails are enabled globally (cached 5 minutes)

### Where used:
1. **LineItemAttachmentsPanel.tsx** (line ~130-140)
   - Fetches attachments for expanded line item attachments view
   - Query key: `[filesApiPath]` or `["disabled-attachments"]` when no path
   - Enabled when: `!!filesApiPath`

2. **LineItemsSection.tsx** - `LineItemThumb` component (line ~147-162)
   - Fetches attachments for single thumbnail preview in collapsed line item row
   - Query key: `[filesApiPath]`
   - Enabled when: `!!lineItemId`

3. **LineItemsSection.tsx** - `LineItemArtworkStrip` component (line ~230-245)
   - Fetches attachments for horizontal thumbnail strip (up to 3 thumbs + "+N")
   - Query key: `[filesApiPath]`
   - Enabled when: `!!lineItemId`

4. **LineItemsSection.tsx** - `LineItemArtworkBadge` component (line ~1145-1160)
   - Fetches attachments to show file count badge
   - Query key: `[filesApiPath]`
   - Enabled when: `!!lineItemId`

### Attachments included in response?
**YES** - Attachments are fetched directly via dedicated line item files endpoints, NOT included in quote detail response.

### Notes:
- All four components use the **SAME query key pattern** `[filesApiPath]`, so React Query automatically deduplicates them
- TanStack Query's cache sharing means all four components receive updates when ANY of them refetches
- The quote detail query (`["/api/quotes", quoteId]` in `useQuoteEditorState.ts` line ~247) does NOT include attachments
- Attachments are fetched separately per line item, not as part of the quote payload
- No existing `refetchInterval` or polling logic currently implemented

---

## Attachment DTO Fields (Actual Names + Enum Values)

### Thumb status field name + possible values:
**Field:** `thumbStatus` (camelCase in client DTOs, maps to `thumb_status` DB column)  
**Enum values:**
- `'uploaded'` - Initial state for non-PDF images
- `'thumb_pending'` - Thumbnail generation queued/in progress
- `'thumb_ready'` - Thumbnail successfully generated
- `'thumb_failed'` - Thumbnail generation failed

**Source:** `shared/schema.ts` line 980 (`thumbStatusEnum`), used in `quoteAttachments` and `quoteAttachmentPages` tables

### PageCount status field name + possible values:
**Field:** `pageCountStatus` (DB column name, not observed in client code - may be backend-only or not yet exposed)  
**Enum values (inferred from server code):**
- `'unknown'` - Initial state
- `'detecting'` - Page counting in progress
- `'known'` - Page count successfully determined
- `'failed'` - Page counting failed

**Note:** `pageCountStatus` is NOT referenced in any client code searched. The client only checks `pageCount` (number) directly.

### Thumb key/url fields:
**Storage keys (opaque identifiers, never used as URLs):**
- `thumbKey` (string | null) - GCS storage key for thumbnail
- `previewKey` (string | null) - GCS storage key for preview/medium-res image

**Signed URLs (generated by backend):**
- `thumbUrl` (string | null) - Signed URL for thumbnail
- `previewUrl` (string | null) - Signed URL for preview
- `originalUrl` (string | null) - Signed URL for original file

**Pattern:** Client ALWAYS uses signed URLs (`*Url` fields), NEVER constructs URLs from keys. Keys are backend-only identifiers.

### PageCount fields:
- `pageCount` (number | null) - Number of pages in PDF (null for non-PDFs or unknown)
- `pages` (array | undefined) - Array of per-page thumbnail metadata for PDFs:
  ```typescript
  {
    id: string;
    pageIndex: number;
    thumbStatus: 'uploaded' | 'thumb_pending' | 'thumb_ready' | 'thumb_failed';
    thumbKey?: string | null;
    previewKey?: string | null;
    thumbError?: string | null;
    thumbUrl?: string | null;
    previewUrl?: string | null;
  }
  ```

### Additional observed fields:
- `thumbError` (string | null) - Error message when `thumbStatus === 'thumb_failed'`
- Special error check: `isThumbsUnavailableError(thumbError)` - detects system-level thumb unavailability (e.g., Sharp not installed)

---

## UI Components

### Thumb strip component path + how it gets data:
**Path:** `client/src/features/quotes/editor/components/LineItemsSection.tsx`  
**Component:** `LineItemArtworkStrip` (lines ~218-330)  
**Data source:**
- Direct `useQuery` with key `[filesApiPath]`
- Shows up to 3 thumbnails + "+N" indicator
- Renders in collapsed line item row
- Clicking thumb opens preview modal (`onPreview` callback)

### Expanded attachments component path + how it gets data:
**Path:** `client/src/components/LineItemAttachmentsPanel.tsx`  
**Component:** `LineItemAttachmentsPanel` (main export, lines ~69-1171)  
**Data source:**
- Direct `useQuery` with key `[filesApiPath]` (line ~130-140)
- Full-featured panel with upload, delete, thumbnail regeneration, download
- Shows detailed status badges for `thumbStatus` (line ~823-836):
  - ✓ Thumbs ready (green)
  - ⏳ Generating... (amber)
  - ✗ Generation failed (red)
  - Thumbnails temporarily unavailable (muted, for system-level errors)
- Renders in expanded line item accordion section

### Preview modal component path + how it gets data:
**Paths (two identical implementations):**
1. `client/src/features/quotes/editor/components/LineItemsSection.tsx` (lines ~928-1096)
2. `client/src/components/LineItemAttachmentsPanel.tsx` (lines ~948-1171)

**Component:** `<Dialog>` with preview content (not a separate component, inline JSX)  
**Data source:**
- Receives attachment object via local state (`previewFile` from `useState`)
- Does NOT refetch - uses already-loaded attachment data passed from parent
- Shows full-size preview image or PDF thumbnail (first page)
- Displays `pageCount` via `AttachmentPreviewMeta` component when applicable

**Note:** Preview modal does NOT have its own query - it displays data from the line item attachments query that triggered it.

---

## Recommended Polling Insertion Point

### The one query/hook to add conditional refetchInterval to later:
**Query location:** `LineItemAttachmentsPanel.tsx` lines ~130-140  
**Query key:** `[filesApiPath]`  
**Condition for polling:**
- Poll when ANY attachment in the response has:
  - `thumbStatus === 'thumb_pending'` OR
  - `pageCountStatus === 'detecting'` (if exposed to client in future)
- Stop polling when ALL attachments are in terminal state:
  - `thumbStatus` is `'thumb_ready'` OR `'thumb_failed'` OR `'uploaded'`
  - AND `pageCount` is present (number) OR file is not a PDF

**Proposed interval:** 2-3 seconds during active processing

### Why it will update all three views:
1. **Cache key sharing:** All four components (`LineItemAttachmentsPanel`, `LineItemThumb`, `LineItemArtworkStrip`, `LineItemArtworkBadge`) use the IDENTICAL query key pattern `[filesApiPath]` for the same `lineItemId`
2. **TanStack Query deduplication:** React Query automatically shares the single cached result across all components
3. **Automatic re-render:** When the query refetches and receives updated `thumbStatus` values, ALL components subscribed to that query key re-render with fresh data
4. **Preview modal:** Uses already-loaded data from parent component, so when parent's query updates, next preview open will show updated status

### Risks/edge cases to handle:

#### 1. Multiple line items with pending thumbs
- **Issue:** If 3 line items are expanded simultaneously, each would poll independently
- **Mitigation:** Polling should be per-query (per `filesApiPath`), so each line item polls only its own attachments. This is acceptable - background processing can handle parallel polling.

#### 2. Component unmount during polling
- **Issue:** User collapses line item while thumbnails are generating
- **Mitigation:** React Query automatically stops polling when no components are subscribed to the query. When user re-expands, query will refetch immediately due to `staleTime` default.

#### 3. Stuck in "pending" state (server-side failure without status update)
- **Issue:** Attachment stuck at `thumb_pending` indefinitely if worker crashes
- **Mitigation:** Implement polling timeout (e.g., stop after 60 seconds, show manual retry button). Add max polling duration logic: `Date.now() - attachmentCreatedAt > 60000`.

#### 4. Race condition: New file upload during polling
- **Issue:** User uploads new file while existing files are processing
- **Mitigation:** React Query automatically handles this - new upload triggers immediate refetch, polling continues for any still-pending files.

#### 5. System-level thumbnail unavailability
- **Issue:** Thumbnails disabled or Sharp unavailable (detected via `isThumbsUnavailableError`)
- **Mitigation:** Do NOT poll if ALL files have `thumb_failed` with unavailability error. Add early-exit check before enabling polling.

#### 6. Quote editor page-level state
- **Issue:** Polling continues when user navigates away from quote editor
- **Mitigation:** React Query automatically stops polling when components unmount. No special handling needed.

#### 7. Network errors during polling
- **Issue:** Transient network failures should not stop polling permanently
- **Mitigation:** Use React Query's `retry` and `retryDelay` options. Consider exponential backoff for polling interval if repeated failures occur.

---

## Files Changed (Expected for Step 2 Implementation)
**This audit step:** Only this markdown file  
**Next step (polling implementation):**
- `client/src/components/LineItemAttachmentsPanel.tsx` - add `refetchInterval` logic to attachments query
- Possibly: helper function to check if polling is needed (e.g., `shouldPollAttachments(attachments: LineItemAttachment[]): boolean`)

---

## Key File Paths Inspected
- `client/src/components/LineItemAttachmentsPanel.tsx` (1171 lines) - Primary attachments panel
- `client/src/features/quotes/editor/components/LineItemsSection.tsx` (1100 lines) - Line items + thumb strip + preview modal
- `client/src/features/quotes/editor/useQuoteEditorState.ts` (2494 lines) - Quote state management (quote query)
- `client/src/lib/attachments.ts` (82 lines) - Attachment helper utilities
- `client/src/components/AttachmentPreviewMeta.tsx` (26 lines) - Page count display component
- `shared/schema.ts` - `thumbStatusEnum` definition (line 980)
- `server/services/thumbnailGenerator.ts` - Backend thumb processing (status updates)
- `server/services/pdfProcessing.ts` - Backend PDF/page count processing
- `server/routes.ts` - Line item files endpoints (lines ~3400-3750)

---

## Summary
The attachment fetching architecture is **already well-structured for bounded polling**:
- Single query key pattern shared across all views
- Terminal status values clearly defined
- No existing polling to conflict with
- Multiple UI components automatically benefit from cache updates

**Next step recommendation:** Add `refetchInterval` to the `useQuery` in `LineItemAttachmentsPanel.tsx` with conditional logic that polls only when `thumbStatus === 'thumb_pending'` exists in response array.
